<!-- Autor: Daniel Benjamin Perez Morales -->
<!-- GitHub: https://github.com/D4nitrix13 -->
<!-- GitLab: https://gitlab.com/D4nitrix13 -->
<!-- Correo electrónico: danielperezdev@proton.me -->

# **Formularios en Laravel**

> [!NOTE]
> *Laravel es un framework MVC (Model-View-Controller), lo que significa que separa la lógica de la aplicación en tres capas principales: Modelo (gestiona los datos y la lógica de negocio), Vista (interfaz de usuario) y Controlador (maneja la interacción entre el modelo y la vista). Esta estructura facilita el mantenimiento, la escalabilidad y la organización del código.*

## **Creación de una tabla de pruebas**

**Para almacenar contactos, creamos una tabla en la base de datos utilizando SQL:**

```sql
CREATE TABLE contacts(  
  id int NOT NULL PRIMARY KEY GENERATED ALWAYS AS IDENTITY, -- Identificador único autoincremental
  name TEXT, -- Nombre del contacto
  phone_number TEXT -- Número de teléfono del contacto
);

COMMENT ON TABLE contacts IS 'Table Contacts'; -- Agregamos un comentario descriptivo a la tabla
COMMENT ON COLUMN contacts.name IS 'Name Contact'; -- Comentario para la columna name
```

*Este código crea una tabla llamada `contacts` con tres columnas:*

- **`id`:** *Identificador único de cada contacto, generado automáticamente.*
- **`name`:** *Almacena el nombre del contacto.*
- **`phone_number`:** *Guarda el número de teléfono del contacto.*

*Los comentarios ayudan a documentar la estructura de la base de datos para facilitar su mantenimiento y comprensión.*

### **Explicación de cada parte:**

- **`CREATE TABLE contacts`**  
  *→ Se está creando una tabla llamada `contacts`.*

- **`id int NOT NULL PRIMARY KEY GENERATED ALWAYS AS IDENTITY`**  
  - **`id int`:** *La columna `id` es de tipo `int` (número entero).*
  - **`NOT NULL`:** *No permite valores nulos, es decir, cada fila debe tener obligatoriamente un valor en esta columna.*
  - **`PRIMARY KEY`:** *Define `id` como clave primaria, lo que significa que cada valor en esta columna debe ser único y sirve como identificador de cada fila.*
  - **`GENERATED ALWAYS AS IDENTITY`:**  
    - *Indica que la columna `id` se genera automáticamente sin necesidad de especificar un valor manualmente al insertar datos.*
    - **Equivale a `SERIAL` en PostgreSQL**, pero es la forma estándar recomendada.  
    - *Funciona como un autoincremento, asignando un valor único automáticamente a cada nuevo registro.*
    - **Alternativa:** *Se puede usar `GENERATED BY DEFAULT AS IDENTITY` si se quiere permitir que el usuario asigne un valor manualmente en algunos casos.*

- **`name TEXT`**  
  *→ Define la columna `name` como un campo de texto de longitud variable. Se usará para almacenar el nombre del contacto.*

- **`phone_number TEXT`**  
  *→ Define la columna `phone_number` también como un campo de texto. Se usa `TEXT` en lugar de `INT` para permitir caracteres como `+`, `-` o espacios en números de teléfono.*

---

### **Agregando comentarios a la tabla y columnas**

```sql
COMMENT ON TABLE contacts IS 'Table Contacts';
COMMENT ON COLUMN contacts.name IS 'Name Contact';
```

#### **Explicación de cada comando:**

- **`COMMENT ON TABLE contacts IS 'Table Contacts';`**  
  *→ Agrega una descripción a la tabla `contacts`. Esto es útil para documentar la base de datos y proporcionar información sobre su propósito.*

- **`COMMENT ON COLUMN contacts.name IS 'Name Contact';`**  
  *→ Agrega una descripción a la columna `name`. Sirve para clarificar qué tipo de información almacena esa columna.*

## **Ruta endpoint POST en Laravel**

*Definimos una ruta para recibir datos desde un formulario y almacenarlos en la base de datos:*

```php
Route::post(
    "/contact",
    function (Request $request) {
        $data = $request->all(); // Obtenemos todos los datos enviados en la petición
        DB::statement(
            "INSERT INTO contacts (name, phone_number) VALUES (?, ?)",
            [
                $data["name"], // Nombre del contacto recibido
                $data["phone_number"] // Número de teléfono recibido
            ]
        );

        return Response::json(
            ["message" => "Contact Stored"], // Respuesta JSON con mensaje de éxito
            200 // Código de estado HTTP 200 (OK)
        );
    }
);
```

### **Explicación del código**

- **`Route::post("/contact", function (Request $request) {...}`:** *Define una ruta `POST` para la URL `/contact`.*
- **`$request->all();`:** *Obtiene los datos enviados en la petición.*
- **`DB::statement(...)`:** *Ejecuta una consulta SQL directa para insertar un nuevo contacto en la base de datos.*
- **`Response::json([...], 200)`:** *Devuelve una respuesta JSON con un mensaje de éxito y el código de estado `200`.*

## **Haciendo una petición para probar la funcionalidad**

*Antes de ejecutar la petición, es importante haber iniciado sesión y autenticado correctamente para que Laravel permita la acción.*

*Ejecutamos el siguiente comando `curl` para enviar un contacto a la base de datos:*

```bash
curl -sSLX POST http://172.17.0.2/contact \
     -H "Content-Type: application/x-www-form-urlencoded" \
     -H "X-XSRF-TOKEN: eyJpdiI6ImtnTHZLbGxXN3VEUlZVTlRUNmpmYVE9PSIsInZhbHVlIjoiblVxUVFtazlrQVJjK1hyakpOV2U1WjFOR003Y3dGckc0bU9QT3lXYy9Jc2hpRFBMUzUxblFpZjBRbm80WmNDbUdxSitQRmpNamJaUGdqY3ZLWjBxMjdpR1Rmb3ZTd2tyU0h3RXNzRFc3bkFWSytaSHloaEI0SjBHQmxRY1RiZlQiLCJtYWMiOiI1ZDQxNDFkMjhjNTEyYzQzZDcyMjIzY2UwODI3Mzc5MDQ2MTVmOWM5ZjJlZDJiMTlkNGMwNTg1OWMxMmNjMzEzIiwidGFnIjoiIn0=" \
     -H "Cookie: contacts_app_session=eyJpdiI6InI2eGtKU250RU1uZjBWRkoxb2FHK2c9PSIsInZhbHVlIjoiN3FOMHdKM04yRW5pR2d5ZTJLdzVLVzh0NktZd1hZUE5CQ3U3eVREbks2V0w0Y2JtNGdYMkFsSjZLU2lacGQ5eGtrcEFqL2JaYStCVVFRN1VOZUs0cHdyaFBZTHFxd3VyNW1iejdURkl2RWZkWURBYm9CQ3dlYVljY3U4TXFNM08iLCJtYWMiOiI5Yzk5NGM2MThjZmZmMGUyNmFhODQwNzJmODNkMTc0MjQ3MjcwNGRiYWU0MTM0ODhjODgwNjU2NGNmODkwY2JhIiwidGFnIjoiIn0%3D; XSRF-TOKEN=eyJpdiI6ImtnTHZLbGxXN3VEUlZVTlRUNmpmYVE9PSIsInZhbHVlIjoiblVxUVFtazlrQVJjK1hyakpOV2U1WjFOR003Y3dGckc0bU9QT3lXYy9Jc2hpRFBMUzUxblFpZjBRbm80WmNDbUdxSitQRmpNamJaUGdqY3ZLWjBxMjdpR1Rmb3ZTd2tyU0h3RXNzRFc3bkFWSytaSHloaEI0SjBHQmxRY1RiZlQiLCJtYWMiOiI1ZDQxNDFkMjhjNTEyYzQzZDcyMjIzY2UwODI3Mzc5MDQ2MTVmOWM5ZjJlZDJiMTlkNGMwNTg1OWMxMmNjMzEzIiwidGFnIjoiIn0=" \
     --data "name=Daniel&phone_number=12345678" \
     | jq --ascii-output --indent 2 --color-output
```

### **Explicación del comando `curl`**

- **`-sSLX POST`:** *Indica que estamos haciendo una petición `POST`.*
- **`-H "Content-Type: application/x-www-form-urlencoded"`:** *Especifica el tipo de contenido enviado.*
- **`-H "X-XSRF-TOKEN: <TOKEN_CSRF>"`:** *Se envía el token CSRF necesario para evitar ataques de falsificación de solicitudes.*
- **`-H "Cookie: contacts_app_session=<SESSION_COOKIE>; XSRF-TOKEN=<TOKEN_CSRF>"`:** *Se incluyen las cookies de sesión y el token CSRF para autenticación.*
- **`--data "name=Daniel&phone_number=12345678"`:** *Especificamos los datos que se enviarán en la solicitud.*
- **`| jq --ascii-output --indent 2 --color-output`:** *Formatea la salida JSON para facilitar la lectura.*

### **Respuesta esperada en JSON**

```json
{
  "message": "Contact Stored"
}
```

*Si la petición es válida, el contacto se almacena en la base de datos y se devuelve una confirmación en formato JSON.*

## **Verificación de la base de datos**

**Para verificar que los datos han sido almacenados correctamente, ejecutamos la siguiente consulta en la base de datos:**

```sql
contacts_app=# SELECT * FROM contacts;
```

### **Salida esperada**

```sql
id |  name  | phone_number
----+--------+--------------
  1 | Daniel | 12345678
```

**Esto confirma que el contacto ha sido almacenado correctamente.**

## **Eliminación de la tabla**

**Si necesitamos eliminar la tabla de contactos, ejecutamos:**

```sql
contacts_app=# DROP TABLE contacts;
```

*Esto elimina completamente la tabla `contacts` junto con todos los datos almacenados en ella.*

---

## **Recursos adicionales**

- *[Documentación oficial de Laravel sobre formularios](https://laravel.com/docs/12.x/requests#retrieving-input "https://laravel.com/docs/12.x/requests#retrieving-input")*
- *[Uso de `curl` para pruebas de APIs](https://curl.se/docs/ "https://curl.se/docs/")*
- *[Protección contra ataques CSRF en Laravel](https://laravel.com/docs/12.x/csrf "https://laravel.com/docs/12.x/csrf")*

---

### **`document.form.submit()` y `fetch`**

> [!IMPORTANT]
> **`document.form.submit()` y `fetch`** *funcionan en un navegador porque están diseñados para interactuar con el entorno del navegador, que maneja cookies, encabezados y sesiones de manera automática. Sin embargo, `curl` no tiene la capacidad de manejar ciertas características que los navegadores sí, como la gestión de cookies de sesión y los tokens CSRF en cabeceras. Además, los navegadores permiten ejecutar solicitudes de manera asincrónica, mientras que `curl` es un cliente HTTP que se ejecuta de manera más sencilla y no tiene la misma capacidad de interacción.*

## **¿Por qué no funcionan con `curl`?**

1. **Manejo de cookies:** *Cuando usas `curl`, debes asegurarte de que estás enviando las cookies correctamente. En un navegador, las cookies de sesión se gestionan automáticamente, pero en `curl`, necesitas enviarlas explícitamente.*

2. **Cabecera CSRF:** *En un navegador, el token CSRF puede ser manejado automáticamente (especialmente si se incluye en las cookies). Sin embargo, con `curl`, debes asegurarte de que estás enviando correctamente el token CSRF en las cabeceras.*

3. **Redirección o procesamiento en el servidor:** *Al realizar una solicitud `POST` usando `curl`, el servidor puede estar configurado para redirigir al navegador después de una solicitud exitosa o realizar otro tipo de procesamiento que no se maneja correctamente en `curl`.*
